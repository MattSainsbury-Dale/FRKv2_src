% ---- Packages ----


\usepackage[utf8]{inputenc} % Need this package whenever you use unicode (non ASCII) characters ()

\usepackage[svgnames]{xcolor} % colours (put here because another package I load later also loads xcolor, but with a different options, which causes a clash)

% Same indentation over multiple lines in algorithm: use tabularx to figure out the width of a box that would fit until the end of the line:
\usepackage{tabularx}
\makeatletter
\newcommand{\multiline}[1]{%
  \begin{tabularx}{\dimexpr\linewidth-\ALG@thistlm}[t]{@{}X@{}}
    #1
  \end{tabularx}
}
\makeatother

\usepackage{afterpage}

\usepackage{enumerate}

% \usepackage{enumitem}

\usepackage{setspace}
% \onehalfspacing
\setstretch{1.2}

\usepackage{tocloft}    % table of contents spacing.
\setcounter{tocdepth}{2} % set only subsection
% \usepackage{fancyhdr}   % Headers & Footers
% \usepackage{lastpage}   % "Page x of y"



\usepackage{amsmath}	% align environment.
\usepackage{amsfonts}	% \mathbb{} (used for Real number symbol, etc.)
\usepackage{amsthm}		% mathy stuff (Theorems, Lemmas, etc.)
\usepackage{commath}
\usepackage{bbm} % \mathbb{} doesn't support digits (1, 2, 3, etc.), so use \mathbbm{} in these instances
\usepackage{mathtools} % \vdotswithin command to have vertical dots between equals signs

\usepackage{import}     % Import .tex files. Split document into sections for readability
\usepackage{graphicx} % Important command of \includegraphics
\usepackage{float} % force figures to remain in place with '[H]'
\usepackage{multirow} % Making tables
\usepackage{subcaption,siunitx,booktabs}
\usepackage{arydshln} % dashed hline and cline

\usepackage{tikz}
\usetikzlibrary{matrix,chains,positioning,decorations.pathreplacing,arrows}
\usepackage{adjustbox}




% ---- Document formatting/hyper links ----

% modify the paragraph 
\usepackage{titlesec}
\setcounter{secnumdepth}{4}
\titleformat{\paragraph}
{\normalfont\normalsize\bfseries}{\theparagraph}{1em}{}
\titlespacing*{\paragraph}
{0pt}{3.25ex plus 1ex minus .2ex}{1.5ex plus .2ex}


\usepackage[paper=a4paper,top=20mm,left=20mm,right=20mm,bottom=20mm]{geometry}

%% Apparently we should not change these manually (or do so with care).
%% Changing them can have unintended consequences, such as the extra vertical space below lstlisting environments (which is how I find this "best practice rule")
% \setlength{\parindent}{0cm}
% \setlength{\headheight}{15pt}
% \setlength{\parskip}{3ex}

%% Add indentation to the first paragraph after a section heading:
% \usepackage{indentfirst}

%% Add line skips between paragraphs rather than indentation (applies to whole document)
\usepackage{parskip}

%% Allows \texttt{} and \url{} to be hyphenated, so they dont go into the margin
\PassOptionsToPackage{hyphens}{url}\usepackage{hyperref}
\hypersetup{colorlinks,linkcolor=blue,citecolor=blue,urlcolor=blue}
\usepackage[htt]{hyphenat}

%% prevent some words from being hyphenated
%% (Doesn't work for words with underscore: just using \mbox{} at each occurence)
% \hyphenation{normalise\_wts} 


\usepackage{xurl} % allows line breaks in url

%% table of contents spacing changes
\setlength\cftbeforesecskip{12pt}
\setlength\cftbeforesubsecskip{3pt}
\setlength\cftbeforesubsubsecskip{3pt}

\usepackage{appendix} % 'appendices' environment

% \usepackage{natbib} % References, bibtex
\usepackage[authoryear,semicolon]{natbib} % References, bibtex
% \usepackage[nottoc]{tocbibind} % Force References to appear in TOC
% \usepackage[nottoc,numbib]{tocbibind} % Force References to appear in TOC WITH A NUMBER IN THE TOC


% ---- Text mode commands ----
\newcommand{\red}[1]{\textcolor{red}{#1}} 

% ---- Math mode commands ----

\usepackage{rotating} % \rotatebox

%% Nice boldface math
\def\mbf#1{{%         \mbf{X} makes X a math bold letter
\mathchoice%          selects with respect to current style
{\hbox{\boldmath$\displaystyle{#1}$}}%      case 1 is displaystyle
{\hbox{\boldmath$\textstyle{#1}$}}%         case 2 is textstyle
{\hbox{\boldmath$\scriptstyle{#1}$}}%       case 3 is scriptstyle
{\hbox{\boldmath$\scriptscriptstyle{#1}$}}% case 4 is scriptscriptstyle
}}
\def\vec{\mbf}

%% General maths commands
\newcommand{\lr}[1]{\left(#1\right)} 
\def\d{\textrm{d}} % Define the "d" for use in integrals.
\newcommand{\logit}[1]{\text{logit}\!\left(#1\right)} % logit function
\newcommand{\logistic}[1]{\text{logistic}\!\left(#1\right)} % logistic function
\DeclareMathOperator*{\argmax}{arg\,max} % argmax
\DeclareMathOperator*{\argmin}{arg\,min} % argmin
\DeclareMathOperator{\Lagr}{\mathcal{L}} % Lagrangian L
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}} % number within align*
\newcommand{\explr}[1]{\exp\!\left(#1\right)} % exp function with brackets (makes converting between e^{#1} and exp(#1) extremely easy)
\newcommand{\lnlr}[1]{\ln\!\left(#1\right)} % ln function with brackets 
\newcommand{\loglr}[1]{\log\!\left(#1\right)} % ln function with brackets 

%% General stats commands
\newcommand{\Gau}{{\text{Gau}}}
\def\inddist{\:\stackrel{\text{ind}}{\sim}\:}
\newcommand{\simiid}{\overset{\text{iid}}{\sim}}
\newcommand{\E}[1]{\mathbb{E}\left(#1\right)} % Expectation operator
\newcommand{\ENoLR}[1]{\mathbb{E}(#1)} % Expectation operator
\newcommand{\ECurly}[1]{\mathbb{E}\left\{#1\right\}} % Expec operator, curly brackets
\newcommand{\ESquare}[1]{\mathbb{E}\left[#1\right]} % Expec operator, square brackets
\newcommand{\var}[1]{{\rm var}\left(#1\right)} % variance operator
\newcommand{\precision}[1]{{\rm prec}\left(#1\right)} % precision operator
\newcommand{\precisionNoLR}[1]{{\rm prec}(#1)} % precision operator
\newcommand{\varCurly}[1]{{\rm var}\left\{#1\right\}} % variance operator, curly brackets
\newcommand{\varSquare}[1]{{\rm var}\left[#1\right]} % variance operator, square brackets 
\newcommand{\cov}[2]{{\rm cov}\left(#1,\;\; #2\right)} % covariance operator
\newcommand{\covCurly}[2]{{\rm cov}\left\{#1,\;\; #2\right\}} % covariance operator, curly brackets
\newcommand{\covCurlyConditional}[3]{{\rm cov}\left\{#1,\; #2 \mid #3\right\}} % covariance operator, curly brackets
\newcommand{\covSquare}[2]{{\rm cov}\left[#1,\;\; #2\right]} % covariance operator, square brackets
\newcommand{\indep}{\rotatebox[origin=c]{90}{$\models$}} % Independent Symbol: \indep

%% Linear algebra commands
\newcommand{\rank}[1]{{\rm rank}\left(#1\right)}
\newcommand{\tr}[1]{{\rm tr}\left(#1\right)}
\newcommand{\tp}{{\!\scriptscriptstyle \top}}
\newcommand{\vecFN}[1]{{\rm vec \!}\left(#1\right)} % vec operator
\newcommand{\diag}[1]{\text{diag}\left(#1\right)} % diag function: \diag

%% Predictor and MSPE definitions (Honours thesis and FRK paper)
% \newcommand{\muZgivenY}[1]{\mu_{Z|Y}(#1)} 
\newcommand{\muZgivenY}[1]{\mu(#1)} 
\newcommand{\pYgivenZ}[1]{\hat{p}_{Y|\vec{Z}}\left(#1\right)} 
\newcommand{\pmugivenZ}[1]{\hat{p}_{\mu|\vec{Z}}\left(#1\right)} 
\newcommand{\pmugivenZApprox}[1]{\check{p}_{\mu|\vec{Z}}\left(#1\right)} 
\newcommand{\pZgivenZ}[1]{\hat{p}_{Z|\vec{Z}}\left(#1\right)} 
\newcommand{\MSPE}[1]{\text{MSPE}\left\{#1\right\}} 
\newcommand{\MSPEtwoarg}[2]{\text{MSPE}\left\{#1, #2\right\}} 
\newcommand{\YObs}{\vec{Y\!}_Z} % Y(.) at observation locations

%% Bayesian statistics
\newcommand{\posterior}{p(\vec{\theta}\mid \vec{y})} 
\newcommand{\prior}{p(\vec{\theta})} 
\newcommand{\lhood}{p(\vec{y} \mid \vec{\theta})} 
\newcommand{\marginal}{p(\vec{y})} 
\newcommand{\unnormalisedPosterior}{q(\vec{\theta}\mid \vec{y})} 
\newcommand{\proposal}{g(\vec{\theta})}
\newcommand{\vtheta}{\vec{\theta}}


%% Computer science/deep learning
\newcommand{\softmax}[1]{\text{softmax}\!\left(#1\right)}

%% Define a \hat{} that will fit over any function input. 
\usepackage{scalerel,stackengine}
\stackMath
\newcommand\reallywidehat[1]{%
\savestack{\tmpbox}{\stretchto{%
  \scaleto{%
    \scalerel*[\widthof{\ensuremath{#1}}]{\kern-.6pt\bigwedge\kern-.6pt}%
    {\rule[-\textheight/2]{1ex}{\textheight}}%WIDTH-LIMITED BIG WEDGE
  }{\textheight}% 
}{0.5ex}}%
\stackon[1pt]{#1}{\tmpbox}%
}




%% Commands which I think I can throw away
%% (but leaving here temporarily to be safe):
% \newcommand{\tauDt}{\vec{\tau_{d}}^\tp}
% \def\Cov{\operatorname{Cov}}% Covariance function: \Cov
% \def\Var{\operatorname{Var}}% Variance function: \Var
% \def\Bias{\operatorname{Bias}} % Bias function: \Bias
% \def\MSE{\operatorname{MSE}} % Mean Square Error function: \MSE
% \newcommand{\ta}{{\tilde{\alpha}}}
% \newcommand{\tb}{{\tilde{\beta}}}


% ---- Result environments ----

%% Follows the convention:   \newtheorem{name}{Printed output}[numberby]
\newtheorem{Result}{Result}[subsection] 
\theoremstyle{definition}
\newtheorem{Theorem}{Theorem}[section] 
\newtheorem{Definition}{Definition}[section] 
\newtheorem*{Aside}{Aside}
\newtheorem*{Corollary}{Corollary}
\newtheorem{Example}{Example}[section] 
\newtheorem*{Notation}{Notation} 
\newtheorem{Proposition}{Proposition}[section] 

%% algorithm environments
\usepackage{algpseudocode,algorithm,algorithmicx}
\newcommand*\Let[2]{\State #1 $\gets$ #2}
\algrenewcommand\algorithmicrequire{\textbf{Precondition:}}
\algrenewcommand\algorithmicensure{\textbf{Postcondition:}}


% ---- Colours ----



\definecolor{darkgreen}{rgb}{0.01, 0.75, 0.24}

%% Colours used in lstlisting styles
\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codemerkygreen}{rgb}{0, 0.53, 0.45}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codeblue}{rgb}{0,0.2,0.67}
\definecolor{backcolour}{gray}{0.975}
\definecolor{codepurple}{rgb}{0.68, 0.04, 0.52}

\definecolor{TMBgray}{rgb}{0.4,0.4,0.4}
\definecolor{TMBgreen}{rgb}{0,0.8,0.6}
\definecolor{TMBorange}{rgb}{1.0,0.4,0}


% ---- lstlisting ----

\usepackage{listings} % Presenting code

\lstdefinestyle{myR}{
    language=R,
    keywordstyle=\color{blue}\bfseries,,
    commentstyle=\color{DarkGreen},
    stringstyle=\color{DarkGreen},
    basicstyle={\color{red}},
    identifierstyle={\color{black}}, 
%
    literate=*
    {*}{{{\color{black}*}}}{1}
    {=}{{{\color{black}=}}}{1}
    {;}{{{\color{black};}}}{1}
    {.7}{{{\color{red}.7}}}{2},%
%
morekeywords={int32_t}
}


\lstdefinestyle{R}{
    language=R,
    basicstyle=\small\ttfamily,
    breaklines=TRUE,
    columns=fixed,
    showstringspaces=false,
    fontadjust=true,
    basewidth=0.5em,
    backgroundcolor=\color{backcolour},
    stringstyle=\color{DarkGreen},
    commentstyle=\color{DarkGreen},
    keywordstyle=\color{blue}\bfseries,
    otherkeywords={0,1,2,3,4,5,6,7,8,9},
    morekeywords={TRUE,FALSE},
    deletekeywords={data,frame,length,as,character,par,env,dyn,load,beta,model,set,list,rnorm,solve,rep,response,nrow,Q,link,matrix,ncol,nrow,mean,plot,scale,palette,df,range,lower,upper,sum,sqrt,sample,runif,exp,log,vector,table,apply,D,which,unique,diag,names,split,report,xy,col,expression,c,rbind,layout,quantile,t,dim,function,start,end,rm,coef,grid,by,count,local,real,seq,predict,time,index,library,numeric},
    % frame=single,
    frame=none, % can also use frame=single, frame=lr, frame, etc
    % numbers=left,
    numbers=none,
    numbersep=5pt,
    numberstyle=\tiny\color{TMBgray},
    escapechar=!, % use ! to escape from lstlisting into latex. Can surround numbers within a variable name, e.g., variable!123! so that the numbers are not made blue
    % linewidth=.92\textwidth,
    % xleftmargin=0.04\textwidth
}


% Define the style to be used for TMB C++ code sections
\lstdefinestyle{Cpp}{
    language=C++,
    basicstyle=\small\ttfamily,
    % frame=single,
    frame=none,
    % framesep=15pt,
    breaklines=TRUE,
    columns=fixed,
    showstringspaces=false,
    fontadjust=true,
    basewidth=0.5em,
    commentstyle=\color{TMBorange},
    % numbers=right,
    numbers=none,
    numbersep=5pt,
    numberstyle=\tiny\color{TMBgray},
    keywordstyle=\color{codeblue}\bfseries,
    showspaces=false,
    stringstyle=\color{DarkGreen},
    backgroundcolor=\color{backcolour}
    % linewidth=.90\textwidth,
    % xleftmargin=1cm
}

%% Make tilde appear in middle of font (rather than default top)
% \usepackage{textcomp} % \texttildelow
\lstset{
    literate={~} {$\sim$}{1}
    % literate={~} {\textasciitilde}{1}
    % literate = {~} {\texttildelow}{1}
}

%% Increase space between listings env. and surrounding text
\lstset{
    aboveskip = 20pt,
    belowskip = 20pt
}



%% Packages
\usepackage{authblk} % affiliations in title page
\usepackage{longtable}
\usepackage{supertabular}
\usepackage{pbox} % formatting cells (forced line break within a cell)
% \newcommand{\specialcell}[2][c]{%
%   \begin{tabular}[#1]{@{}c@{}}#2\end{tabular}} % formatiing cells: see here: https://tex.stackexchange.com/a/19678

% \usepackage{ulem} % stikeout with \sout{}. DONT USE THIS AS IT MESSES UP THE REFERENCES

\usepackage{setspace}
% \doublespacing
\onehalfspacing




% ---- TiKz stuff ----


% Create tree diagrams:
\usepackage{tikz}
\usepackage{tikz-qtree}
\usepackage{pgf}
\usetikzlibrary{positioning}
\usetikzlibrary{arrows, automata}
\usetikzlibrary{shapes.geometric}
% \documentclass[tikz]{standalone}
\usetikzlibrary{arrows.meta}
\usetikzlibrary{matrix} % for the grid



%% Define square nodes:
\makeatletter
% the contents of \squarecorner were mostly stolen from pgfmoduleshapes.code.tex
\def\squarecorner#1{
    % Calculate x
    %
    % First, is width < minimum width?
    \pgf@x=\the\wd\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@xc{\pgfkeysvalueof{/pgf/inner xsep}}%
    \advance\pgf@x by 2\pgf@xc%
    \pgfmathsetlength\pgf@xb{\pgfkeysvalueof{/pgf/minimum width}}%
    \ifdim\pgf@x<\pgf@xb%
        % yes, too small. Enlarge...
        \pgf@x=\pgf@xb%
    \fi%
    % Calculate y
    %
    % First, is height+depth < minimum height?
    \pgf@y=\ht\pgfnodeparttextbox%
    \advance\pgf@y by\dp\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@yc{\pgfkeysvalueof{/pgf/inner ysep}}%
    \advance\pgf@y by 2\pgf@yc%
    \pgfmathsetlength\pgf@yb{\pgfkeysvalueof{/pgf/minimum height}}%
    \ifdim\pgf@y<\pgf@yb%
        % yes, too small. Enlarge...
        \pgf@y=\pgf@yb%
    \fi%
    %
    % this \ifdim is the actual part that makes the node dimensions square.
    \ifdim\pgf@x<\pgf@y%
        \pgf@x=\pgf@y%
    \else
        \pgf@y=\pgf@x%
    \fi
    %
    % Now, calculate right border: .5\wd\pgfnodeparttextbox + .5 \pgf@x + #1outer sep
    \pgf@x=#1.5\pgf@x%
    \advance\pgf@x by.5\wd\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@xa{\pgfkeysvalueof{/pgf/outer xsep}}%
    \advance\pgf@x by#1\pgf@xa%
    % Now, calculate upper border: .5\ht-.5\dp + .5 \pgf@y + #1outer sep
    \pgf@y=#1.5\pgf@y%
    \advance\pgf@y by-.5\dp\pgfnodeparttextbox%
    \advance\pgf@y by.5\ht\pgfnodeparttextbox%
    \pgfmathsetlength\pgf@ya{\pgfkeysvalueof{/pgf/outer ysep}}%
    \advance\pgf@y by#1\pgf@ya%
}
\makeatother


\pgfdeclareshape{square}{
    \savedanchor\northeast{\squarecorner{}}
    \savedanchor\southwest{\squarecorner{-}}

    \foreach \x in {east,west} \foreach \y in {north,mid,base,south} {
        \inheritanchor[from=rectangle]{\y\space\x}
    }
    \foreach \x in {east,west,north,mid,base,south,center,text} {
        \inheritanchor[from=rectangle]{\x}
    }
    \inheritanchorborder[from=rectangle]
    \inheritbackgroundpath[from=rectangle]
}


\definecolor{darkgreen}{rgb}{0.01, 0.75, 0.24}

\newcommand\green[1]{\textcolor{darkgreen}{#1}}
\newcommand\orange[1]{\textcolor{orange}{#1}}



